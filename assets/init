#!/bin/bash

set -e

CONFIG_DIR="/root/config"
CONFIG_MYCNF="${CONFIG_DIR}/my.cnf.template"
MYCNF_TEMPLATE="/etc/my.cnf.template"
MYCNF_DEFAULT="/etc/my.cnf"

SORT_BUFFER_SIZE=${SORT_BUFFER_SIZE:-2M}

SLOW_QUERY_TIME=${SLOW_QUERY_TIME:-10}
MAX_CONNECTIONS=${MAX_CONNECTIONS:-96}

INNODB_BUFFER_POOL_SIZE=${INNODB_BUFFER_POOL_SIZE:-256M}
INNODB_LOG_BUFFER_SIZE=${INNODB_LOG_BUFFER_SIZE:-16M}
INNODB_BUFFER_POOL_INSTANCES=${INNODB_BUFFER_POOL_INSTANCES:-2}
INNODB_MEMORY_POOL_DICT=${INNODB_MEMORY_POOL_DICT:-16M}
INNODB_DATA_FILES=${INNODB_DATA_FILES:-ibdata1:512M:autoextend}
INNODB_AUTOEXTEND_SIZE=${INNODB_AUTOEXTEND_SIZE:-128}

MYISAM_KEY_BUFFER_SIZE=${MYISAM_KEY_BUFFER_SIZE:-4M}
MYISAM_READ_BUFFER_SIZE=${MYISAM_READ_BUFFER_SIZE:-1M}


if [ ! -f $MYCNF_TEMPLATE ]; then
    cp ${CONFIG_MYCNF} ${MYCNF_TEMPLATE}
    cat ${MYCNF_TEMPLATE} >${MYCNF_DEFAULT}

    sed 's/{{SORT_BUFFER_SIZE}}/'${SORT_BUFFER_SIZE}'/' -i ${MYCNF_DEFAULT}

    sed 's/{{SLOW_QUERY_TIME}}/'${SLOW_QUERY_TIME}'/' -i ${MYCNF_DEFAULT}
    sed 's/{{MAX_CONNECTIONS}}/'${MAX_CONNECTIONS}'/' -i ${MYCNF_DEFAULT}

    sed 's/{{INNODB_BUFFER_POOL_SIZE}}/'${INNODB_BUFFER_POOL_SIZE}'/' -i ${MYCNF_DEFAULT}
    sed 's/{{INNODB_LOG_BUFFER_SIZE}}/'${INNODB_LOG_BUFFER_SIZE}'/' -i ${MYCNF_DEFAULT}
    sed 's/{{INNODB_BUFFER_POOL_INSTANCES}}/'${INNODB_BUFFER_POOL_INSTANCES}'/' -i ${MYCNF_DEFAULT}
    sed 's/{{INNODB_MEMORY_POOL_DICT}}/'${INNODB_MEMORY_POOL_DICT}'/' -i ${MYCNF_DEFAULT}
    sed 's/{{INNODB_DATA_FILES}}/'${INNODB_DATA_FILES}'/' -i ${MYCNF_DEFAULT}
    sed 's/{{INNODB_AUTOEXTEND_SIZE}}/'${INNODB_AUTOEXTEND_SIZE}'/' -i ${MYCNF_DEFAULT}

    sed 's/{{MYISAM_KEY_BUFFER_SIZE}}/'${MYISAM_KEY_BUFFER_SIZE}'/' -i ${MYCNF_DEFAULT}
    sed 's/{{MYISAM_READ_BUFFER_SIZE}}/'${MYISAM_READ_BUFFER_SIZE}'/' -i ${MYCNF_DEFAULT}
fi

# vim: set ts=4 et
